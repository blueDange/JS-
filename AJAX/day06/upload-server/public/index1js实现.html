<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>JS方案</title>
</head>

<body>
    <!-- Form表单方案只适合最基础的文件上传 -->
    <!-- 如果希望监听上传的结果, 进行一些个性化操作, 则需要JS的介入 -->
    <div id="box">
        <!-- accept: 设置可选的文件类型, 浏览时看不到非图片的文件 -->
        <input type="file" name="avatar" id="" accept="image/*" />
        <button>上传</button>
    </div>
    <img src="" alt="" />

    <p id="percent"></p>

    <script src="./jquery.min.js"></script>
    <script>
        // 点击上传按钮, 获取文件内容信息, 用ajax上传文件
        $('#box>button').on('click', function () {
            console.log($(this).prev()) //查看文件选择框的值
            // 获取元素的files属性
            var files = $(this).prev().prop('files')
            console.log('files', files)
            // 容错处理: 如果没有选择文件, 则提示 并 结束函数执行
            if (files.length == 0) {
                alert('未选择上传文件!')
                return
            }

            // 验证大小, 超过2M 弹出提示
            // size: 默认单位 Byte,  1024Byte = 1KB  1024KB = 1MB
            var size = (files[0].size / 1024 / 1024).toFixed(2)

            if (size > 2) {
                alert('文件大小不允许超过2M : ' + size)
                return
            }

            // 必须图片类型, 即 type属性的值 必须包含 image 字样
            if (files[0].type.indexOf('image') == -1) {
                alert('只允许图片类型!')
                return
            }

            // 上传操作: 把文件封装到 FormData 类型的对象里
            var fd = new FormData()
            // append: 添加新的数据项
            // 参数1: 名字, 与服务器的设定要一致
            fd.append('avatar', files[0])

            // 文件上传不属于常用功能, JQ没有封装独立的方法, 只能用最原始的ajax 方案
            $.ajax({
                // 上传进度
                // xhr: 监听原生的XHR相关信息
                xhr() {
                    var xhr = new XMLHttpRequest()
                    // 监听 upload 操作的 进度progress 变化
                    xhr.upload.addEventListener('progress', function (e) {
                        // console.log(e)
                        // loaded: 已加载的大小; total总大小
                        var percent = (e.loaded / e.total).toFixed(2) * 100 + '%'
                        console.log(percent)
                        // 显示到页面上
                        $('#percent').html(percent)
                    })
                    return xhr
                },

                url: 'http://localhost:3000/upload', //上传的接口地址
                type: 'post', //请求方式
                data: fd, //上传的数据
                processData: false, //不要对原始数据编码,  文本类型才需要编码
                contentType: false, //不要更改FormData的内容类型, 默认会改成文本
                //上传成功后的回调
                success(res) {
                    console.log(res)
                    // 保存在服务器上的文件名
                    var filename = res.filename
                    // 设置图片的src属性, 值为图片的地址
                    $('#box+img').prop('src', `http://localhost:3000/${filename}`)
                },
            })
        })
    </script>
</body>

</html>